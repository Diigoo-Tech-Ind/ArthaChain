name: ArthaChain CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  rust-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev
      - name: Cargo test (blockchain_node)
        run: |
          cargo test -p blockchain_node --all-features --locked
      - name: Run economic simulations
        run: |
          python3 scripts/econ/sim_emissions.py
          python3 scripts/econ/sim_burn_curve.py
          python3 scripts/econ/sim_storage_supply.py
          python3 scripts/econ/sim_deal_market.py
      - name: Upload econ CSV artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: econ-csv
          path: data/econ/*.csv

  foundry-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Foundry toolchain
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly
      - name: Forge tests
        working-directory: contracts
        run: |
          forge --version
          forge test -vvv
          forge test --ffi --runs 256 --mc ArthaCoinInvariants -vvv

  echidna-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Echidna property tests
        working-directory: contracts
        run: |
          docker --version
          docker run --rm -v "$PWD":/work -w /work/contracts trailofbits/echidna \
            echidna-test contracts/test/ArthaCoinEchidna.sol --config contracts/echidna.yaml || echo "Echidna tests skipped if config not found"

  service-build-test:
    name: Build All Service Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build blockchain node
        run: docker build -f blockchain_node/Dockerfile -t arthachain-node:test .
      - name: Build AI services
        run: |
          docker build -f services/ai-jobd/Dockerfile -t ai-jobd:test .
          docker build -f services/ai-scheduler/Dockerfile -t ai-scheduler:test .
          docker build -f services/ai-runtime/Dockerfile -t ai-runtime:test .
          docker build -f services/ai-proofs/Dockerfile -t ai-proofs:test .
          docker build -f services/policy-gate/Dockerfile -t policy-gate:test .
          docker build -f services/ai-agents/Dockerfile -t ai-agents:test .
          docker build -f services/ai-federation/Dockerfile -t ai-federation:test .
          docker build -f services/ai-evolution/Dockerfile -t ai-evolution:test .
          docker build -f services/ai-ethics/Dockerfile -t ai-ethics:test .
      - name: Verify images
        run: |
          docker images | grep -E "(arthachain-node|ai-jobd|ai-scheduler|ai-runtime|ai-proofs|policy-gate|ai-agents|ai-federation|ai-evolution|ai-ethics)" | head -10


