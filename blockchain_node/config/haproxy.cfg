# ArthaChain HAProxy Configuration
# Load balancer for production deployment

global
    daemon
    log stdout local0
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option httpchk GET /health
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Stats page
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Main API Load Balancer (Port 1900)
frontend arthachain_api_frontend
    bind *:1900
    default_backend arthachain_api_backend

backend arthachain_api_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server arthachain-node-1 arthachain-node:1900 check inter 5s fall 3 rise 2
    server arthachain-global-api-1 arthachain-global-api:1910 check inter 5s fall 3 rise 2 backup

# RPC Load Balancer (Port 1970)
frontend arthachain_rpc_frontend
    bind *:1970
    default_backend arthachain_rpc_backend

backend arthachain_rpc_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server arthachain-rpc-1 arthachain-rpc:1970 check inter 5s fall 3 rise 2

# Wallet API Load Balancer (Port 1980)
frontend arthachain_wallet_frontend
    bind *:1980
    default_backend arthachain_wallet_backend

backend arthachain_wallet_backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    server arthachain-wallet-1 arthachain-wallet:1980 check inter 5s fall 3 rise 2
