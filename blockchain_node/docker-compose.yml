version: '3.8'

services:
  arthachain-node:
    build: .
    container_name: arthachain-mainnet
    restart: unless-stopped
    
    ports:
      # API Server
      - "8080:8080"
      # JSON-RPC
      - "8545:8545" 
      # WebSocket
      - "9944:9944"
      # P2P Network
      - "30303:30303"
    
    volumes:
      # Persistent data storage
      - arthachain_data:/app/data
      - arthachain_logs:/app/logs
      # Configuration
      - ./docker/production.toml:/app/config/production.toml:ro
    
    environment:
      - RUST_LOG=info
      - ARTHACHAIN_ENV=production
      - ARTHACHAIN_CONFIG=/app/config/production.toml
      - ARTHACHAIN_DATA_DIR=/app/data
      - ARTHACHAIN_LOG_DIR=/app/logs
      # Production API settings
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - RPC_HOST=0.0.0.0  
      - RPC_PORT=8545
      - WS_HOST=0.0.0.0
      - WS_PORT=9944
      - P2P_PORT=30303
      # Network configuration
      - CHAIN_ID=201766
      - NETWORK_NAME=arthachain_mainnet
      - MAX_TPS=100000
      - BLOCK_TIME=3000
      # Security settings
      - ENABLE_FRAUD_DETECTION=true
      - ENABLE_QUANTUM_SVBFT=true
      - ENABLE_SHARDING=true
      - ENABLE_AI_OPTIMIZATION=true
    
    networks:
      - arthachain-network
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.arthachain-api.rule=Host(`arthavhain.in`)"
      - "traefik.http.routers.arthachain-api.tls=true"
      - "traefik.http.routers.arthachain-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.arthachain-api.loadbalancer.server.port=8080"
    
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Optional: Load balancer/reverse proxy
  traefik:
    image: traefik:v2.10
    container_name: arthachain-proxy
    restart: unless-stopped
    
    ports:
      - "80:80"
      - "443:443"
      - "8090:8080"
    
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik.yml:/traefik.yml:ro
      - traefik_letsencrypt:/letsencrypt
    
    networks:
      - arthachain-network
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.arthavhain.in`)"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"

  # Optional: Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: arthachain-prometheus
    restart: unless-stopped
    
    ports:
      - "9090:9090"
    
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    
    networks:
      - arthachain-network

networks:
  arthachain-network:
    driver: bridge

volumes:
  arthachain_data:
    driver: local
  arthachain_logs:
    driver: local
  traefik_letsencrypt:
    driver: local
  prometheus_data:
    driver: local
